{% extends 'base.html.twig' %}

{% block title %}Réservation au guichet{% endblock %}

{% block body %}
    <h1 class="text-center text-warning mb-4">Réservation pour {{ seance.film.title }}</h1>

    <div class="d-flex flex-column align-items-center gap-2">
        {% for row in seats|batch(16, '') %}
            <div class="d-flex gap-1 justify-content-center">
                {% for seat in row %}
                    {% if seat %}
                        {% set isReserved = seat.id in reservedSeatIds %}
                        <div
                            class="seat text-white fw-bold d-flex justify-content-center align-items-center"
                            data-seat-id="{{ seat.id }}"
                            data-disabled="{{ isReserved ? 'true' : 'false' }}"
                            style="
                                width:40px; height:40px; border-radius:5px;
                                background-color: {{ isReserved ? '#dc3545' : '#6c757d' }};
                                cursor: {{ isReserved ? 'not-allowed' : 'pointer' }};
                                "
                        >
                            {{ seat.number }}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endfor %}
        <button class="btn btn-success mt-4 d-block mx-auto" id="confirm-reservation">Confirmer la réservation</button>
    </div>


    <script>
        document.querySelectorAll('.seat').forEach(seat => {
            if (seat.dataset.disabled === 'false') {
                seat.addEventListener('click', () => {
                    if (seat.style.backgroundColor === 'blue') {

                        seat.style.backgroundColor = '#6c757d';
                    } else {

                        seat.style.backgroundColor = 'blue';
                    }
                });
            }
        });

        document.getElementById('confirm-reservation').addEventListener('click', () => {
            const selectedSeats = Array.from(document.querySelectorAll('.seat'))
                .filter(seat => seat.style.backgroundColor === 'blue')
                .map(seat => seat.dataset.seatId);

            if (selectedSeats.length === 0) {
                alert("Veuillez sélectionner au moins une place !");
                return;
            }

            fetch('{{ path("employee_confirm_booking", {id: seance.id}) }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ seats: selectedSeats }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Réservation confirmée !");
                        window.location.reload();
                    } else {
                        alert(data.message || "Erreur lors de la réservation.");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Erreur");
                });
        });

    </script>
{% endblock %}
